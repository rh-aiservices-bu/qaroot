FROM registry.access.redhat.com/ubi9/nodejs-20:latest

USER 0

WORKDIR /opt/app-root/src

# Copy package files for all workspaces
COPY package*.json tsconfig.json ./
COPY backend/websocket-service/package*.json ./backend/websocket-service/
COPY backend/shared/package*.json ./backend/shared/

# Install dependencies
RUN npm ci

# Copy source code
COPY backend/websocket-service ./backend/websocket-service
COPY backend/shared ./backend/shared

# Build shared library
WORKDIR /opt/app-root/src/backend/shared
RUN npm run build

# Return to root
WORKDIR /opt/app-root/src

# Set working directory to websocket-service
WORKDIR /opt/app-root/src/backend/websocket-service

# Expose port
EXPOSE 3001

USER 1001

CMD ["npx", "tsx", "src/index.ts"]
